import{f as se,g as Mi,$ as Ei,a as p,h as Pi,c as xi,d as xr,e as Oi,i as $i,j as Di,H as Or,b as j}from"./index-DvOc7OqZ.js";var pe,$r;function ji(){if($r)return pe;$r=1;function i(){this.__data__=[],this.size=0}return pe=i,pe}var ve,Dr;function Ua(){if(Dr)return ve;Dr=1;function i(t,e){return t===e||t!==t&&e!==e}return ve=i,ve}var ge,jr;function ce(){if(jr)return ge;jr=1;var i=Ua();function t(e,r){for(var n=e.length;n--;)if(i(e[n][0],r))return n;return-1}return ge=t,ge}var _e,Lr;function Li(){if(Lr)return _e;Lr=1;var i=ce(),t=Array.prototype,e=t.splice;function r(n){var a=this.__data__,s=i(a,n);if(s<0)return!1;var o=a.length-1;return s==o?a.pop():e.call(a,s,1),--this.size,!0}return _e=r,_e}var be,Br;function Bi(){if(Br)return be;Br=1;var i=ce();function t(e){var r=this.__data__,n=i(r,e);return n<0?void 0:r[n][1]}return be=t,be}var ye,Fr;function Fi(){if(Fr)return ye;Fr=1;var i=ce();function t(e){return i(this.__data__,e)>-1}return ye=t,ye}var me,Ur;function Ui(){if(Ur)return me;Ur=1;var i=ce();function t(e,r){var n=this.__data__,a=i(n,e);return a<0?(++this.size,n.push([e,r])):n[a][1]=r,this}return me=t,me}var we,Vr;function ue(){if(Vr)return we;Vr=1;var i=ji(),t=Li(),e=Bi(),r=Fi(),n=Ui();function a(s){var o=-1,u=s==null?0:s.length;for(this.clear();++o<u;){var c=s[o];this.set(c[0],c[1])}}return a.prototype.clear=i,a.prototype.delete=t,a.prototype.get=e,a.prototype.has=r,a.prototype.set=n,we=a,we}var Se,Nr;function Vi(){if(Nr)return Se;Nr=1;var i=ue();function t(){this.__data__=new i,this.size=0}return Se=t,Se}var ke,Gr;function Ni(){if(Gr)return ke;Gr=1;function i(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r}return ke=i,ke}var Ae,zr;function Gi(){if(zr)return Ae;zr=1;function i(t){return this.__data__.get(t)}return Ae=i,Ae}var Ce,Kr;function zi(){if(Kr)return Ce;Kr=1;function i(t){return this.__data__.has(t)}return Ce=i,Ce}var Re,Wr;function Va(){if(Wr)return Re;Wr=1;var i=typeof se=="object"&&se&&se.Object===Object&&se;return Re=i,Re}var qe,Hr;function P(){if(Hr)return qe;Hr=1;var i=Va(),t=typeof self=="object"&&self&&self.Object===Object&&self,e=i||t||Function("return this")();return qe=e,qe}var Te,Jr;function pr(){if(Jr)return Te;Jr=1;var i=P(),t=i.Symbol;return Te=t,Te}var Ie,Qr;function Ki(){if(Qr)return Ie;Qr=1;var i=pr(),t=Object.prototype,e=t.hasOwnProperty,r=t.toString,n=i?i.toStringTag:void 0;function a(s){var o=e.call(s,n),u=s[n];try{s[n]=void 0;var c=!0}catch{}var l=r.call(s);return c&&(o?s[n]=u:delete s[n]),l}return Ie=a,Ie}var Me,Yr;function Wi(){if(Yr)return Me;Yr=1;var i=Object.prototype,t=i.toString;function e(r){return t.call(r)}return Me=e,Me}var Ee,Xr;function le(){if(Xr)return Ee;Xr=1;var i=pr(),t=Ki(),e=Wi(),r="[object Null]",n="[object Undefined]",a=i?i.toStringTag:void 0;function s(o){return o==null?o===void 0?n:r:a&&a in Object(o)?t(o):e(o)}return Ee=s,Ee}var Pe,Zr;function ee(){if(Zr)return Pe;Zr=1;function i(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}return Pe=i,Pe}var xe,en;function Na(){if(en)return xe;en=1;var i=le(),t=ee(),e="[object AsyncFunction]",r="[object Function]",n="[object GeneratorFunction]",a="[object Proxy]";function s(o){if(!t(o))return!1;var u=i(o);return u==r||u==n||u==e||u==a}return xe=s,xe}var Oe,tn;function Hi(){if(tn)return Oe;tn=1;var i=P(),t=i["__core-js_shared__"];return Oe=t,Oe}var $e,rn;function Ji(){if(rn)return $e;rn=1;var i=Hi(),t=(function(){var r=/[^.]+$/.exec(i&&i.keys&&i.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""})();function e(r){return!!t&&t in r}return $e=e,$e}var De,nn;function Ga(){if(nn)return De;nn=1;var i=Function.prototype,t=i.toString;function e(r){if(r!=null){try{return t.call(r)}catch{}try{return r+""}catch{}}return""}return De=e,De}var je,an;function Qi(){if(an)return je;an=1;var i=Na(),t=Ji(),e=ee(),r=Ga(),n=/[\\^$.*+?()[\]{}|]/g,a=/^\[object .+?Constructor\]$/,s=Function.prototype,o=Object.prototype,u=s.toString,c=o.hasOwnProperty,l=RegExp("^"+u.call(c).replace(n,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function d(h){if(!e(h)||t(h))return!1;var v=i(h)?l:a;return v.test(r(h))}return je=d,je}var Le,sn;function Yi(){if(sn)return Le;sn=1;function i(t,e){return t?.[e]}return Le=i,Le}var Be,on;function N(){if(on)return Be;on=1;var i=Qi(),t=Yi();function e(r,n){var a=t(r,n);return i(a)?a:void 0}return Be=e,Be}var Fe,cn;function vr(){if(cn)return Fe;cn=1;var i=N(),t=P(),e=i(t,"Map");return Fe=e,Fe}var Ue,un;function de(){if(un)return Ue;un=1;var i=N(),t=i(Object,"create");return Ue=t,Ue}var Ve,ln;function Xi(){if(ln)return Ve;ln=1;var i=de();function t(){this.__data__=i?i(null):{},this.size=0}return Ve=t,Ve}var Ne,dn;function Zi(){if(dn)return Ne;dn=1;function i(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}return Ne=i,Ne}var Ge,hn;function es(){if(hn)return Ge;hn=1;var i=de(),t="__lodash_hash_undefined__",e=Object.prototype,r=e.hasOwnProperty;function n(a){var s=this.__data__;if(i){var o=s[a];return o===t?void 0:o}return r.call(s,a)?s[a]:void 0}return Ge=n,Ge}var ze,fn;function ts(){if(fn)return ze;fn=1;var i=de(),t=Object.prototype,e=t.hasOwnProperty;function r(n){var a=this.__data__;return i?a[n]!==void 0:e.call(a,n)}return ze=r,ze}var Ke,pn;function rs(){if(pn)return Ke;pn=1;var i=de(),t="__lodash_hash_undefined__";function e(r,n){var a=this.__data__;return this.size+=this.has(r)?0:1,a[r]=i&&n===void 0?t:n,this}return Ke=e,Ke}var We,vn;function ns(){if(vn)return We;vn=1;var i=Xi(),t=Zi(),e=es(),r=ts(),n=rs();function a(s){var o=-1,u=s==null?0:s.length;for(this.clear();++o<u;){var c=s[o];this.set(c[0],c[1])}}return a.prototype.clear=i,a.prototype.delete=t,a.prototype.get=e,a.prototype.has=r,a.prototype.set=n,We=a,We}var He,gn;function as(){if(gn)return He;gn=1;var i=ns(),t=ue(),e=vr();function r(){this.size=0,this.__data__={hash:new i,map:new(e||t),string:new i}}return He=r,He}var Je,_n;function is(){if(_n)return Je;_n=1;function i(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}return Je=i,Je}var Qe,bn;function he(){if(bn)return Qe;bn=1;var i=is();function t(e,r){var n=e.__data__;return i(r)?n[typeof r=="string"?"string":"hash"]:n.map}return Qe=t,Qe}var Ye,yn;function ss(){if(yn)return Ye;yn=1;var i=he();function t(e){var r=i(this,e).delete(e);return this.size-=r?1:0,r}return Ye=t,Ye}var Xe,mn;function os(){if(mn)return Xe;mn=1;var i=he();function t(e){return i(this,e).get(e)}return Xe=t,Xe}var Ze,wn;function cs(){if(wn)return Ze;wn=1;var i=he();function t(e){return i(this,e).has(e)}return Ze=t,Ze}var et,Sn;function us(){if(Sn)return et;Sn=1;var i=he();function t(e,r){var n=i(this,e),a=n.size;return n.set(e,r),this.size+=n.size==a?0:1,this}return et=t,et}var tt,kn;function ls(){if(kn)return tt;kn=1;var i=as(),t=ss(),e=os(),r=cs(),n=us();function a(s){var o=-1,u=s==null?0:s.length;for(this.clear();++o<u;){var c=s[o];this.set(c[0],c[1])}}return a.prototype.clear=i,a.prototype.delete=t,a.prototype.get=e,a.prototype.has=r,a.prototype.set=n,tt=a,tt}var rt,An;function ds(){if(An)return rt;An=1;var i=ue(),t=vr(),e=ls(),r=200;function n(a,s){var o=this.__data__;if(o instanceof i){var u=o.__data__;if(!t||u.length<r-1)return u.push([a,s]),this.size=++o.size,this;o=this.__data__=new e(u)}return o.set(a,s),this.size=o.size,this}return rt=n,rt}var nt,Cn;function hs(){if(Cn)return nt;Cn=1;var i=ue(),t=Vi(),e=Ni(),r=Gi(),n=zi(),a=ds();function s(o){var u=this.__data__=new i(o);this.size=u.size}return s.prototype.clear=t,s.prototype.delete=e,s.prototype.get=r,s.prototype.has=n,s.prototype.set=a,nt=s,nt}var at,Rn;function fs(){if(Rn)return at;Rn=1;function i(t,e){for(var r=-1,n=t==null?0:t.length;++r<n&&e(t[r],r,t)!==!1;);return t}return at=i,at}var it,qn;function ps(){if(qn)return it;qn=1;var i=N(),t=(function(){try{var e=i(Object,"defineProperty");return e({},"",{}),e}catch{}})();return it=t,it}var st,Tn;function za(){if(Tn)return st;Tn=1;var i=ps();function t(e,r,n){r=="__proto__"&&i?i(e,r,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[r]=n}return st=t,st}var ot,In;function Ka(){if(In)return ot;In=1;var i=za(),t=Ua(),e=Object.prototype,r=e.hasOwnProperty;function n(a,s,o){var u=a[s];(!(r.call(a,s)&&t(u,o))||o===void 0&&!(s in a))&&i(a,s,o)}return ot=n,ot}var ct,Mn;function fe(){if(Mn)return ct;Mn=1;var i=Ka(),t=za();function e(r,n,a,s){var o=!a;a||(a={});for(var u=-1,c=n.length;++u<c;){var l=n[u],d=s?s(a[l],r[l],l,a,r):void 0;d===void 0&&(d=r[l]),o?t(a,l,d):i(a,l,d)}return a}return ct=e,ct}var ut,En;function vs(){if(En)return ut;En=1;function i(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}return ut=i,ut}var lt,Pn;function te(){if(Pn)return lt;Pn=1;function i(t){return t!=null&&typeof t=="object"}return lt=i,lt}var dt,xn;function gs(){if(xn)return dt;xn=1;var i=le(),t=te(),e="[object Arguments]";function r(n){return t(n)&&i(n)==e}return dt=r,dt}var ht,On;function _s(){if(On)return ht;On=1;var i=gs(),t=te(),e=Object.prototype,r=e.hasOwnProperty,n=e.propertyIsEnumerable,a=i((function(){return arguments})())?i:function(s){return t(s)&&r.call(s,"callee")&&!n.call(s,"callee")};return ht=a,ht}var ft,$n;function gr(){if($n)return ft;$n=1;var i=Array.isArray;return ft=i,ft}var Y={exports:{}},pt,Dn;function bs(){if(Dn)return pt;Dn=1;function i(){return!1}return pt=i,pt}Y.exports;var jn;function Wa(){return jn||(jn=1,(function(i,t){var e=P(),r=bs(),n=t&&!t.nodeType&&t,a=n&&!0&&i&&!i.nodeType&&i,s=a&&a.exports===n,o=s?e.Buffer:void 0,u=o?o.isBuffer:void 0,c=u||r;i.exports=c})(Y,Y.exports)),Y.exports}var vt,Ln;function ys(){if(Ln)return vt;Ln=1;var i=9007199254740991,t=/^(?:0|[1-9]\d*)$/;function e(r,n){var a=typeof r;return n=n??i,!!n&&(a=="number"||a!="symbol"&&t.test(r))&&r>-1&&r%1==0&&r<n}return vt=e,vt}var gt,Bn;function Ha(){if(Bn)return gt;Bn=1;var i=9007199254740991;function t(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=i}return gt=t,gt}var _t,Fn;function ms(){if(Fn)return _t;Fn=1;var i=le(),t=Ha(),e=te(),r="[object Arguments]",n="[object Array]",a="[object Boolean]",s="[object Date]",o="[object Error]",u="[object Function]",c="[object Map]",l="[object Number]",d="[object Object]",h="[object RegExp]",v="[object Set]",f="[object String]",g="[object WeakMap]",w="[object ArrayBuffer]",C="[object DataView]",y="[object Float32Array]",S="[object Float64Array]",A="[object Int8Array]",k="[object Int16Array]",T="[object Int32Array]",x="[object Uint8Array]",B="[object Uint8ClampedArray]",R="[object Uint16Array]",J="[object Uint32Array]",_={};_[y]=_[S]=_[A]=_[k]=_[T]=_[x]=_[B]=_[R]=_[J]=!0,_[r]=_[n]=_[w]=_[a]=_[C]=_[s]=_[o]=_[u]=_[c]=_[l]=_[d]=_[h]=_[v]=_[f]=_[g]=!1;function O(Q){return e(Q)&&t(Q.length)&&!!_[i(Q)]}return _t=O,_t}var bt,Un;function _r(){if(Un)return bt;Un=1;function i(t){return function(e){return t(e)}}return bt=i,bt}var X={exports:{}};X.exports;var Vn;function br(){return Vn||(Vn=1,(function(i,t){var e=Va(),r=t&&!t.nodeType&&t,n=r&&!0&&i&&!i.nodeType&&i,a=n&&n.exports===r,s=a&&e.process,o=(function(){try{var u=n&&n.require&&n.require("util").types;return u||s&&s.binding&&s.binding("util")}catch{}})();i.exports=o})(X,X.exports)),X.exports}var yt,Nn;function ws(){if(Nn)return yt;Nn=1;var i=ms(),t=_r(),e=br(),r=e&&e.isTypedArray,n=r?t(r):i;return yt=n,yt}var mt,Gn;function Ja(){if(Gn)return mt;Gn=1;var i=vs(),t=_s(),e=gr(),r=Wa(),n=ys(),a=ws(),s=Object.prototype,o=s.hasOwnProperty;function u(c,l){var d=e(c),h=!d&&t(c),v=!d&&!h&&r(c),f=!d&&!h&&!v&&a(c),g=d||h||v||f,w=g?i(c.length,String):[],C=w.length;for(var y in c)(l||o.call(c,y))&&!(g&&(y=="length"||v&&(y=="offset"||y=="parent")||f&&(y=="buffer"||y=="byteLength"||y=="byteOffset")||n(y,C)))&&w.push(y);return w}return mt=u,mt}var wt,zn;function yr(){if(zn)return wt;zn=1;var i=Object.prototype;function t(e){var r=e&&e.constructor,n=typeof r=="function"&&r.prototype||i;return e===n}return wt=t,wt}var St,Kn;function Qa(){if(Kn)return St;Kn=1;function i(t,e){return function(r){return t(e(r))}}return St=i,St}var kt,Wn;function Ss(){if(Wn)return kt;Wn=1;var i=Qa(),t=i(Object.keys,Object);return kt=t,kt}var At,Hn;function ks(){if(Hn)return At;Hn=1;var i=yr(),t=Ss(),e=Object.prototype,r=e.hasOwnProperty;function n(a){if(!i(a))return t(a);var s=[];for(var o in Object(a))r.call(a,o)&&o!="constructor"&&s.push(o);return s}return At=n,At}var Ct,Jn;function Ya(){if(Jn)return Ct;Jn=1;var i=Na(),t=Ha();function e(r){return r!=null&&t(r.length)&&!i(r)}return Ct=e,Ct}var Rt,Qn;function mr(){if(Qn)return Rt;Qn=1;var i=Ja(),t=ks(),e=Ya();function r(n){return e(n)?i(n):t(n)}return Rt=r,Rt}var qt,Yn;function As(){if(Yn)return qt;Yn=1;var i=fe(),t=mr();function e(r,n){return r&&i(n,t(n),r)}return qt=e,qt}var Tt,Xn;function Cs(){if(Xn)return Tt;Xn=1;function i(t){var e=[];if(t!=null)for(var r in Object(t))e.push(r);return e}return Tt=i,Tt}var It,Zn;function Rs(){if(Zn)return It;Zn=1;var i=ee(),t=yr(),e=Cs(),r=Object.prototype,n=r.hasOwnProperty;function a(s){if(!i(s))return e(s);var o=t(s),u=[];for(var c in s)c=="constructor"&&(o||!n.call(s,c))||u.push(c);return u}return It=a,It}var Mt,ea;function wr(){if(ea)return Mt;ea=1;var i=Ja(),t=Rs(),e=Ya();function r(n){return e(n)?i(n,!0):t(n)}return Mt=r,Mt}var Et,ta;function qs(){if(ta)return Et;ta=1;var i=fe(),t=wr();function e(r,n){return r&&i(n,t(n),r)}return Et=e,Et}var Z={exports:{}};Z.exports;var ra;function Ts(){return ra||(ra=1,(function(i,t){var e=P(),r=t&&!t.nodeType&&t,n=r&&!0&&i&&!i.nodeType&&i,a=n&&n.exports===r,s=a?e.Buffer:void 0,o=s?s.allocUnsafe:void 0;function u(c,l){if(l)return c.slice();var d=c.length,h=o?o(d):new c.constructor(d);return c.copy(h),h}i.exports=u})(Z,Z.exports)),Z.exports}var Pt,na;function Is(){if(na)return Pt;na=1;function i(t,e){var r=-1,n=t.length;for(e||(e=Array(n));++r<n;)e[r]=t[r];return e}return Pt=i,Pt}var xt,aa;function Ms(){if(aa)return xt;aa=1;function i(t,e){for(var r=-1,n=t==null?0:t.length,a=0,s=[];++r<n;){var o=t[r];e(o,r,t)&&(s[a++]=o)}return s}return xt=i,xt}var Ot,ia;function Xa(){if(ia)return Ot;ia=1;function i(){return[]}return Ot=i,Ot}var $t,sa;function Sr(){if(sa)return $t;sa=1;var i=Ms(),t=Xa(),e=Object.prototype,r=e.propertyIsEnumerable,n=Object.getOwnPropertySymbols,a=n?function(s){return s==null?[]:(s=Object(s),i(n(s),function(o){return r.call(s,o)}))}:t;return $t=a,$t}var Dt,oa;function Es(){if(oa)return Dt;oa=1;var i=fe(),t=Sr();function e(r,n){return i(r,t(r),n)}return Dt=e,Dt}var jt,ca;function Za(){if(ca)return jt;ca=1;function i(t,e){for(var r=-1,n=e.length,a=t.length;++r<n;)t[a+r]=e[r];return t}return jt=i,jt}var Lt,ua;function ei(){if(ua)return Lt;ua=1;var i=Qa(),t=i(Object.getPrototypeOf,Object);return Lt=t,Lt}var Bt,la;function ti(){if(la)return Bt;la=1;var i=Za(),t=ei(),e=Sr(),r=Xa(),n=Object.getOwnPropertySymbols,a=n?function(s){for(var o=[];s;)i(o,e(s)),s=t(s);return o}:r;return Bt=a,Bt}var Ft,da;function Ps(){if(da)return Ft;da=1;var i=fe(),t=ti();function e(r,n){return i(r,t(r),n)}return Ft=e,Ft}var Ut,ha;function ri(){if(ha)return Ut;ha=1;var i=Za(),t=gr();function e(r,n,a){var s=n(r);return t(r)?s:i(s,a(r))}return Ut=e,Ut}var Vt,fa;function xs(){if(fa)return Vt;fa=1;var i=ri(),t=Sr(),e=mr();function r(n){return i(n,e,t)}return Vt=r,Vt}var Nt,pa;function Os(){if(pa)return Nt;pa=1;var i=ri(),t=ti(),e=wr();function r(n){return i(n,e,t)}return Nt=r,Nt}var Gt,va;function $s(){if(va)return Gt;va=1;var i=N(),t=P(),e=i(t,"DataView");return Gt=e,Gt}var zt,ga;function Ds(){if(ga)return zt;ga=1;var i=N(),t=P(),e=i(t,"Promise");return zt=e,zt}var Kt,_a;function js(){if(_a)return Kt;_a=1;var i=N(),t=P(),e=i(t,"Set");return Kt=e,Kt}var Wt,ba;function Ls(){if(ba)return Wt;ba=1;var i=N(),t=P(),e=i(t,"WeakMap");return Wt=e,Wt}var Ht,ya;function kr(){if(ya)return Ht;ya=1;var i=$s(),t=vr(),e=Ds(),r=js(),n=Ls(),a=le(),s=Ga(),o="[object Map]",u="[object Object]",c="[object Promise]",l="[object Set]",d="[object WeakMap]",h="[object DataView]",v=s(i),f=s(t),g=s(e),w=s(r),C=s(n),y=a;return(i&&y(new i(new ArrayBuffer(1)))!=h||t&&y(new t)!=o||e&&y(e.resolve())!=c||r&&y(new r)!=l||n&&y(new n)!=d)&&(y=function(S){var A=a(S),k=A==u?S.constructor:void 0,T=k?s(k):"";if(T)switch(T){case v:return h;case f:return o;case g:return c;case w:return l;case C:return d}return A}),Ht=y,Ht}var Jt,ma;function Bs(){if(ma)return Jt;ma=1;var i=Object.prototype,t=i.hasOwnProperty;function e(r){var n=r.length,a=new r.constructor(n);return n&&typeof r[0]=="string"&&t.call(r,"index")&&(a.index=r.index,a.input=r.input),a}return Jt=e,Jt}var Qt,wa;function Fs(){if(wa)return Qt;wa=1;var i=P(),t=i.Uint8Array;return Qt=t,Qt}var Yt,Sa;function Ar(){if(Sa)return Yt;Sa=1;var i=Fs();function t(e){var r=new e.constructor(e.byteLength);return new i(r).set(new i(e)),r}return Yt=t,Yt}var Xt,ka;function Us(){if(ka)return Xt;ka=1;var i=Ar();function t(e,r){var n=r?i(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}return Xt=t,Xt}var Zt,Aa;function Vs(){if(Aa)return Zt;Aa=1;var i=/\w*$/;function t(e){var r=new e.constructor(e.source,i.exec(e));return r.lastIndex=e.lastIndex,r}return Zt=t,Zt}var er,Ca;function Ns(){if(Ca)return er;Ca=1;var i=pr(),t=i?i.prototype:void 0,e=t?t.valueOf:void 0;function r(n){return e?Object(e.call(n)):{}}return er=r,er}var tr,Ra;function Gs(){if(Ra)return tr;Ra=1;var i=Ar();function t(e,r){var n=r?i(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}return tr=t,tr}var rr,qa;function zs(){if(qa)return rr;qa=1;var i=Ar(),t=Us(),e=Vs(),r=Ns(),n=Gs(),a="[object Boolean]",s="[object Date]",o="[object Map]",u="[object Number]",c="[object RegExp]",l="[object Set]",d="[object String]",h="[object Symbol]",v="[object ArrayBuffer]",f="[object DataView]",g="[object Float32Array]",w="[object Float64Array]",C="[object Int8Array]",y="[object Int16Array]",S="[object Int32Array]",A="[object Uint8Array]",k="[object Uint8ClampedArray]",T="[object Uint16Array]",x="[object Uint32Array]";function B(R,J,_){var O=R.constructor;switch(J){case v:return i(R);case a:case s:return new O(+R);case f:return t(R,_);case g:case w:case C:case y:case S:case A:case k:case T:case x:return n(R,_);case o:return new O;case u:case d:return new O(R);case c:return e(R);case l:return new O;case h:return r(R)}}return rr=B,rr}var nr,Ta;function Ks(){if(Ta)return nr;Ta=1;var i=ee(),t=Object.create,e=(function(){function r(){}return function(n){if(!i(n))return{};if(t)return t(n);r.prototype=n;var a=new r;return r.prototype=void 0,a}})();return nr=e,nr}var ar,Ia;function Ws(){if(Ia)return ar;Ia=1;var i=Ks(),t=ei(),e=yr();function r(n){return typeof n.constructor=="function"&&!e(n)?i(t(n)):{}}return ar=r,ar}var ir,Ma;function Hs(){if(Ma)return ir;Ma=1;var i=kr(),t=te(),e="[object Map]";function r(n){return t(n)&&i(n)==e}return ir=r,ir}var sr,Ea;function Js(){if(Ea)return sr;Ea=1;var i=Hs(),t=_r(),e=br(),r=e&&e.isMap,n=r?t(r):i;return sr=n,sr}var or,Pa;function Qs(){if(Pa)return or;Pa=1;var i=kr(),t=te(),e="[object Set]";function r(n){return t(n)&&i(n)==e}return or=r,or}var cr,xa;function Ys(){if(xa)return cr;xa=1;var i=Qs(),t=_r(),e=br(),r=e&&e.isSet,n=r?t(r):i;return cr=n,cr}var ur,Oa;function Xs(){if(Oa)return ur;Oa=1;var i=hs(),t=fs(),e=Ka(),r=As(),n=qs(),a=Ts(),s=Is(),o=Es(),u=Ps(),c=xs(),l=Os(),d=kr(),h=Bs(),v=zs(),f=Ws(),g=gr(),w=Wa(),C=Js(),y=ee(),S=Ys(),A=mr(),k=wr(),T=1,x=2,B=4,R="[object Arguments]",J="[object Array]",_="[object Boolean]",O="[object Date]",Q="[object Error]",qr="[object Function]",ci="[object GeneratorFunction]",ui="[object Map]",li="[object Number]",Tr="[object Object]",di="[object RegExp]",hi="[object Set]",fi="[object String]",pi="[object Symbol]",vi="[object WeakMap]",gi="[object ArrayBuffer]",_i="[object DataView]",bi="[object Float32Array]",yi="[object Float64Array]",mi="[object Int8Array]",wi="[object Int16Array]",Si="[object Int32Array]",ki="[object Uint8Array]",Ai="[object Uint8ClampedArray]",Ci="[object Uint16Array]",Ri="[object Uint32Array]",m={};m[R]=m[J]=m[gi]=m[_i]=m[_]=m[O]=m[bi]=m[yi]=m[mi]=m[wi]=m[Si]=m[ui]=m[li]=m[Tr]=m[di]=m[hi]=m[fi]=m[pi]=m[ki]=m[Ai]=m[Ci]=m[Ri]=!0,m[Q]=m[qr]=m[vi]=!1;function re(b,G,z,qi,ne,$){var q,ae=G&T,ie=G&x,Ti=G&B;if(z&&(q=ne?z(b,qi,ne,$):z(b)),q!==void 0)return q;if(!y(b))return b;var Ir=g(b);if(Ir){if(q=h(b),!ae)return s(b,q)}else{var K=d(b),Mr=K==qr||K==ci;if(w(b))return a(b,ae);if(K==Tr||K==R||Mr&&!ne){if(q=ie||Mr?{}:f(b),!ae)return ie?u(b,n(q,b)):o(b,r(q,b))}else{if(!m[K])return ne?b:{};q=v(b,K,ae)}}$||($=new i);var Er=$.get(b);if(Er)return Er;$.set(b,q),S(b)?b.forEach(function(D){q.add(re(D,G,z,D,b,$))}):C(b)&&b.forEach(function(D,F){q.set(F,re(D,G,z,F,b,$))});var Ii=Ti?ie?l:c:ie?k:A,Pr=Ir?void 0:Ii(b);return t(Pr||b,function(D,F){Pr&&(F=D,D=b[F]),e(q,F,re(D,G,z,F,b,$))}),q}return ur=re,ur}var lr,$a;function Zs(){if($a)return lr;$a=1;var i=Xs(),t=1,e=4;function r(n){return i(n,t|e)}return lr=r,lr}var eo=Zs();const to=Mi(eo);function ro(i,t,e,r){Object.defineProperty(i,t,{get:e,set:r,enumerable:!0,configurable:!0})}class E{static floatTo16BitPCM(t){const e=new ArrayBuffer(t.length*2),r=new DataView(e);let n=0;for(let a=0;a<t.length;a++,n+=2){let s=Math.max(-1,Math.min(1,t[a]));r.setInt16(n,s<0?s*32768:s*32767,!0)}return e}static mergeBuffers(t,e){const r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer}_packData(t,e){return[new Uint8Array([e,e>>8]),new Uint8Array([e,e>>8,e>>16,e>>24])][t]}pack(t,e){if(e?.bitsPerSample)if(e?.channels){if(!e?.data)throw new Error('Missing "data"')}else throw new Error('Missing "channels"');else throw new Error('Missing "bitsPerSample"');const{bitsPerSample:r,channels:n,data:a}=e,s=["RIFF",this._packData(1,52),"WAVE","fmt ",this._packData(1,16),this._packData(0,1),this._packData(0,n.length),this._packData(1,t),this._packData(1,t*n.length*r/8),this._packData(0,n.length*r/8),this._packData(0,r),"data",this._packData(1,n[0].length*n.length*r/8),a],o=new Blob(s,{type:"audio/mpeg"}),u=URL.createObjectURL(o);return{blob:o,url:u,channelCount:n.length,sampleRate:t,duration:a.byteLength/(n.length*t*2)}}}globalThis.WavPacker=E;const Da=[4186.01,4434.92,4698.63,4978.03,5274.04,5587.65,5919.91,6271.93,6644.88,7040,7458.62,7902.13],no=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],L=[],Cr=[];for(let i=1;i<=8;i++)for(let t=0;t<Da.length;t++){const e=Da[t];L.push(e/Math.pow(2,8-i)),Cr.push(no[t]+i)}const oe=[32,2e3],ja=L.filter((i,t)=>L[t]>oe[0]&&L[t]<oe[1]),ao=Cr.filter((i,t)=>L[t]>oe[0]&&L[t]<oe[1]);class H{static getFrequencies(t,e,r,n="frequency",a=-100,s=-30){r||(r=new Float32Array(t.frequencyBinCount),t.getFloatFrequencyData(r));const o=e/2,u=1/r.length*o;let c,l,d;if(n==="music"||n==="voice"){const f=n==="voice"?ja:L,g=Array(f.length).fill(a);for(let w=0;w<r.length;w++){const C=w*u,y=r[w];for(let S=f.length-1;S>=0;S--)if(C>f[S]){g[S]=Math.max(g[S],y);break}}c=g,l=n==="voice"?ja:L,d=n==="voice"?ao:Cr}else c=Array.from(r),l=c.map((f,g)=>u*g),d=l.map(f=>`${f.toFixed(2)} Hz`);const h=c.map(f=>Math.max(0,Math.min((f-a)/(s-a),1)));return{values:new Float32Array(h),frequencies:l,labels:d}}constructor(t,e=null){if(this.fftResults=[],e){const{length:r,sampleRate:n}=e,a=new OfflineAudioContext({length:r,sampleRate:n}),s=a.createBufferSource();s.buffer=e;const o=a.createAnalyser();o.fftSize=8192,o.smoothingTimeConstant=.1,s.connect(o);const u=1/60,c=r/n,l=d=>{const h=u*d;h<c&&a.suspend(h).then(()=>{const v=new Float32Array(o.frequencyBinCount);o.getFloatFrequencyData(v),this.fftResults.push(v),l(d+1)}),d===1?a.startRendering():a.resume()};s.start(0),l(1),this.audio=t,this.context=a,this.analyser=o,this.sampleRate=n,this.audioBuffer=e}else{const r=new AudioContext,n=r.createMediaElementSource(t),a=r.createAnalyser();a.fftSize=8192,a.smoothingTimeConstant=.1,n.connect(a),a.connect(r.destination),this.audio=t,this.context=r,this.analyser=a,this.sampleRate=this.context.sampleRate,this.audioBuffer=null}}getFrequencies(t="frequency",e=-100,r=-30){let n=null;if(this.audioBuffer&&this.fftResults.length){const a=this.audio.currentTime/this.audio.duration,s=Math.min(a*this.fftResults.length|0,this.fftResults.length-1);n=this.fftResults[s]}return H.getFrequencies(this.analyser,this.sampleRate,n,t,e,r)}async resumeIfSuspended(){return this.context.state==="suspended"&&await this.context.resume(),!0}}globalThis.AudioAnalysis=H;const io=`
class StreamProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.hasStarted = false;
    this.hasInterrupted = false;
    this.outputBuffers = [];
    this.bufferLength = 128;
    this.write = { buffer: new Float32Array(this.bufferLength), trackId: null };
    this.writeOffset = 0;
    this.trackSampleOffsets = {};
    this.port.onmessage = (event) => {
      if (event.data) {
        const payload = event.data;
        if (payload.event === 'write') {
          const int16Array = payload.buffer;
          const float32Array = new Float32Array(int16Array.length);
          for (let i = 0; i < int16Array.length; i++) {
            float32Array[i] = int16Array[i] / 0x8000; // Convert Int16 to Float32
          }
          this.writeData(float32Array, payload.trackId);
        } else if (
          payload.event === 'offset' ||
          payload.event === 'interrupt'
        ) {
          const requestId = payload.requestId;
          const trackId = this.write.trackId;
          const offset = this.trackSampleOffsets[trackId] || 0;
          this.port.postMessage({
            event: 'offset',
            requestId,
            trackId,
            offset,
          });
          if (payload.event === 'interrupt') {
            this.hasInterrupted = true;
          }
        } else {
          throw new Error(\`Unhandled event "\${payload.event}"\`);
        }
      }
    };
  }

  writeData(float32Array, trackId = null) {
    let { buffer } = this.write;
    let offset = this.writeOffset;
    for (let i = 0; i < float32Array.length; i++) {
      buffer[offset++] = float32Array[i];
      if (offset >= buffer.length) {
        this.outputBuffers.push(this.write);
        this.write = { buffer: new Float32Array(this.bufferLength), trackId };
        buffer = this.write.buffer;
        offset = 0;
      }
    }
    this.writeOffset = offset;
    return true;
  }

  process(inputs, outputs, parameters) {
    const output = outputs[0];
    const outputChannelData = output[0];
    const outputBuffers = this.outputBuffers;
    if (this.hasInterrupted) {
      this.port.postMessage({ event: 'stop' });
      return false;
    } else if (outputBuffers.length) {
      this.hasStarted = true;
      const { buffer, trackId } = outputBuffers.shift();
      for (let i = 0; i < outputChannelData.length; i++) {
        outputChannelData[i] = buffer[i] || 0;
      }
      if (trackId) {
        this.trackSampleOffsets[trackId] =
          this.trackSampleOffsets[trackId] || 0;
        this.trackSampleOffsets[trackId] += buffer.length;
      }
      return true;
    } else if (this.hasStarted) {
      this.port.postMessage({ event: 'stop' });
      return false;
    } else {
      return true;
    }
  }
}

registerProcessor('stream_processor', StreamProcessor);
`,so=new Blob([io],{type:"application/javascript"}),oo=URL.createObjectURL(so),co=oo;class Rr{constructor({sampleRate:t=44100}={}){this.scriptSrc=co,this.sampleRate=t,this.context=null,this.stream=null,this.analyser=null,this.trackSampleOffsets={},this.interruptedTrackIds={}}async connect(){this.context=new AudioContext({sampleRate:this.sampleRate}),this._speakerID&&this.context.setSinkId(this._speakerID),this.context.state==="suspended"&&await this.context.resume();try{await this.context.audioWorklet.addModule(this.scriptSrc)}catch(e){throw console.error(e),new Error(`Could not add audioWorklet module: ${this.scriptSrc}`)}const t=this.context.createAnalyser();return t.fftSize=8192,t.smoothingTimeConstant=.1,this.analyser=t,!0}getFrequencies(t="frequency",e=-100,r=-30){if(!this.analyser)throw new Error("Not connected, please call .connect() first");return H.getFrequencies(this.analyser,this.sampleRate,null,t,e,r)}async updateSpeaker(t){const e=this._speakerID;if(this._speakerID=t,this.context)try{t==="default"?await this.context.setSinkId():await this.context.setSinkId(t)}catch(r){console.error(`Could not set sinkId to ${t}: ${r}`),this._speakerID=e}}_start(){const t=new AudioWorkletNode(this.context,"stream_processor");return t.connect(this.context.destination),t.port.onmessage=e=>{const{event:r}=e.data;if(r==="stop")t.disconnect(),this.stream=null;else if(r==="offset"){const{requestId:n,trackId:a,offset:s}=e.data,o=s/this.sampleRate;this.trackSampleOffsets[n]={trackId:a,offset:s,currentTime:o}}},this.analyser.disconnect(),t.connect(this.analyser),this.stream=t,!0}add16BitPCM(t,e="default"){if(typeof e!="string")throw new Error("trackId must be a string");if(this.interruptedTrackIds[e])return;this.stream||this._start();let r;if(t instanceof Int16Array)r=t;else if(t instanceof ArrayBuffer)r=new Int16Array(t);else throw new Error("argument must be Int16Array or ArrayBuffer");return this.stream.port.postMessage({event:"write",buffer:r,trackId:e}),r}async getTrackSampleOffset(t=!1){if(!this.stream)return null;const e=crypto.randomUUID();this.stream.port.postMessage({event:t?"interrupt":"offset",requestId:e});let r;for(;!r;)r=this.trackSampleOffsets[e],await new Promise(a=>setTimeout(()=>a(),1));const{trackId:n}=r;return t&&n&&(this.interruptedTrackIds[n]=!0),r}async interrupt(){return this.getTrackSampleOffset(!0)}}globalThis.WavStreamPlayer=Rr;const uo=`
class AudioProcessor extends AudioWorkletProcessor {

  constructor() {
    super();
    this.port.onmessage = this.receive.bind(this);
    this.initialize();
  }

  initialize() {
    this.foundAudio = false;
    this.recording = false;
    this.chunks = [];
  }

  /**
   * Concatenates sampled chunks into channels
   * Format is chunk[Left[], Right[]]
   */
  readChannelData(chunks, channel = -1, maxChannels = 9) {
    let channelLimit;
    if (channel !== -1) {
      if (chunks[0] && chunks[0].length - 1 < channel) {
        throw new Error(
          \`Channel \${channel} out of range: max \${chunks[0].length}\`
        );
      }
      channelLimit = channel + 1;
    } else {
      channel = 0;
      channelLimit = Math.min(chunks[0] ? chunks[0].length : 1, maxChannels);
    }
    const channels = [];
    for (let n = channel; n < channelLimit; n++) {
      const length = chunks.reduce((sum, chunk) => {
        return sum + chunk[n].length;
      }, 0);
      const buffers = chunks.map((chunk) => chunk[n]);
      const result = new Float32Array(length);
      let offset = 0;
      for (let i = 0; i < buffers.length; i++) {
        result.set(buffers[i], offset);
        offset += buffers[i].length;
      }
      channels[n] = result;
    }
    return channels;
  }

  /**
   * Combines parallel audio data into correct format,
   * channels[Left[], Right[]] to float32Array[LRLRLRLR...]
   */
  formatAudioData(channels) {
    if (channels.length === 1) {
      // Simple case is only one channel
      const float32Array = channels[0].slice();
      const meanValues = channels[0].slice();
      return { float32Array, meanValues };
    } else {
      const float32Array = new Float32Array(
        channels[0].length * channels.length
      );
      const meanValues = new Float32Array(channels[0].length);
      for (let i = 0; i < channels[0].length; i++) {
        const offset = i * channels.length;
        let meanValue = 0;
        for (let n = 0; n < channels.length; n++) {
          float32Array[offset + n] = channels[n][i];
          meanValue += channels[n][i];
        }
        meanValues[i] = meanValue / channels.length;
      }
      return { float32Array, meanValues };
    }
  }

  /**
   * Converts 32-bit float data to 16-bit integers
   */
  floatTo16BitPCM(float32Array) {
    const buffer = new ArrayBuffer(float32Array.length * 2);
    const view = new DataView(buffer);
    let offset = 0;
    for (let i = 0; i < float32Array.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, float32Array[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
    }
    return buffer;
  }

  /**
   * Retrieves the most recent amplitude values from the audio stream
   * @param {number} channel
   */
  getValues(channel = -1) {
    const channels = this.readChannelData(this.chunks, channel);
    const { meanValues } = this.formatAudioData(channels);
    return { meanValues, channels };
  }

  /**
   * Exports chunks as an audio/wav file
   */
  export() {
    const channels = this.readChannelData(this.chunks);
    const { float32Array, meanValues } = this.formatAudioData(channels);
    const audioData = this.floatTo16BitPCM(float32Array);
    return {
      meanValues: meanValues,
      audio: {
        bitsPerSample: 16,
        channels: channels,
        data: audioData,
      },
    };
  }

  receive(e) {
    const { event, id } = e.data;
    let receiptData = {};
    switch (event) {
      case 'start':
        this.recording = true;
        break;
      case 'stop':
        this.recording = false;
        break;
      case 'clear':
        this.initialize();
        break;
      case 'export':
        receiptData = this.export();
        break;
      case 'read':
        receiptData = this.getValues();
        break;
      default:
        break;
    }
    // Always send back receipt
    this.port.postMessage({ event: 'receipt', id, data: receiptData });
  }

  sendChunk(chunk) {
    const channels = this.readChannelData([chunk]);
    const { float32Array, meanValues } = this.formatAudioData(channels);
    const rawAudioData = this.floatTo16BitPCM(float32Array);
    const monoAudioData = this.floatTo16BitPCM(meanValues);
    this.port.postMessage({
      event: 'chunk',
      data: {
        mono: monoAudioData,
        raw: rawAudioData,
      },
    });
  }

  process(inputList, outputList, parameters) {
    // Copy input to output (e.g. speakers)
    // Note that this creates choppy sounds with Mac products
    const sourceLimit = Math.min(inputList.length, outputList.length);
    for (let inputNum = 0; inputNum < sourceLimit; inputNum++) {
      const input = inputList[inputNum];
      const output = outputList[inputNum];
      const channelCount = Math.min(input.length, output.length);
      for (let channelNum = 0; channelNum < channelCount; channelNum++) {
        input[channelNum].forEach((sample, i) => {
          output[channelNum][i] = sample;
        });
      }
    }
    const inputs = inputList[0];
    // There's latency at the beginning of a stream before recording starts
    // Make sure we actually receive audio data before we start storing chunks
    let sliceIndex = 0;
    if (!this.foundAudio) {
      for (const channel of inputs) {
        sliceIndex = 0; // reset for each channel
        if (this.foundAudio) {
          break;
        }
        if (channel) {
          for (const value of channel) {
            if (value !== 0) {
              // find only one non-zero entry in any channel
              this.foundAudio = true;
              break;
            } else {
              sliceIndex++;
            }
          }
        }
      }
    }
    if (inputs && inputs[0] && this.foundAudio && this.recording) {
      // We need to copy the TypedArray, because the \`process\`
      // internals will reuse the same buffer to hold each input
      const chunk = inputs.map((input) => input.slice(sliceIndex));
      this.chunks.push(chunk);
      this.sendChunk(chunk);
    }
    return true;
  }
}

registerProcessor('audio_processor', AudioProcessor);
`,lo=new Blob([uo],{type:"application/javascript"}),ho=URL.createObjectURL(lo),ni=ho;class ai{constructor({sampleRate:t=44100,outputToSpeakers:e=!1,debug:r=!1}={}){this.scriptSrc=ni,this.sampleRate=t,this.outputToSpeakers=e,this.debug=!!r,this._deviceChangeCallback=null,this._deviceErrorCallback=null,this._devices=[],this.deviceSelection=null,this.stream=null,this.processor=null,this.source=null,this.node=null,this.recording=!1,this._lastEventId=0,this.eventReceipts={},this.eventTimeout=5e3,this._chunkProcessor=()=>{},this._chunkProcessorSize=void 0,this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)}}static async decode(t,e=44100,r=-1){const n=new AudioContext({sampleRate:e});let a,s;if(t instanceof Blob){if(r!==-1)throw new Error('Can not specify "fromSampleRate" when reading from Blob');s=t,a=await s.arrayBuffer()}else if(t instanceof ArrayBuffer){if(r!==-1)throw new Error('Can not specify "fromSampleRate" when reading from ArrayBuffer');a=t,s=new Blob([a],{type:"audio/wav"})}else{let l,d;if(t instanceof Int16Array){d=t,l=new Float32Array(t.length);for(let g=0;g<t.length;g++)l[g]=t[g]/32768}else if(t instanceof Float32Array)l=t;else if(t instanceof Array)l=new Float32Array(t);else throw new Error('"audioData" must be one of: Blob, Float32Arrray, Int16Array, ArrayBuffer, Array<number>');if(r===-1)throw new Error('Must specify "fromSampleRate" when reading from Float32Array, In16Array or Array');if(r<3e3)throw new Error('Minimum "fromSampleRate" is 3000 (3kHz)');d||(d=E.floatTo16BitPCM(l));const h={bitsPerSample:16,channels:[l],data:d};s=new E().pack(r,h).blob,a=await s.arrayBuffer()}const o=await n.decodeAudioData(a),u=o.getChannelData(0),c=URL.createObjectURL(s);return{blob:s,url:c,values:u,audioBuffer:o}}log(){return this.debug&&this.log(...arguments),!0}getSampleRate(){return this.sampleRate}getStatus(){return this.processor?this.recording?"recording":"paused":"ended"}async _event(t,e={},r=null){if(r=r||this.processor,!r)throw new Error("Can not send events without recording first");const n={event:t,id:this._lastEventId++,data:e};r.port.postMessage(n);const a=new Date().valueOf();for(;!this.eventReceipts[n.id];){if(new Date().valueOf()-a>this.eventTimeout)throw new Error(`Timeout waiting for "${t}" event`);await new Promise(o=>setTimeout(()=>o(!0),1))}const s=this.eventReceipts[n.id];return delete this.eventReceipts[n.id],s}listenForDeviceChange(t){if(t===null&&this._deviceChangeCallback)navigator.mediaDevices.removeEventListener("devicechange",this._deviceChangeCallback),this._deviceChangeCallback=null;else if(t!==null){let e=0,r=[];const n=s=>s.map(o=>o.deviceId).sort().join(","),a=async()=>{let s=++e;const o=await this.listDevices();s===e&&n(r)!==n(o)&&(r=o,t(o.slice()))};navigator.mediaDevices.addEventListener("devicechange",a),a(),this._deviceChangeCallback=a}return!0}listenForDeviceErrors(t){this._deviceErrorCallback=t}async requestPermission(){const t=await navigator.permissions.query({name:"microphone"});if(t.state==="denied")this._deviceErrorCallback&&this._deviceErrorCallback({devices:["mic"],type:"unknown",error:new Error("Microphone access denied")});else if(t.state==="prompt")try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(n=>n.stop())}catch(e){console.error("Error accessing microphone."),this._deviceErrorCallback&&this._deviceErrorCallback({devices:["mic"],type:"unknown",error:e})}return!0}async listDevices(){if(!navigator.mediaDevices||!("enumerateDevices"in navigator.mediaDevices))throw new Error("Could not request user devices");return await this.requestPermission(),(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="audioinput")}async begin(t){if(this.processor)throw new Error("Already connected: please call .end() to start a new session");if(!navigator.mediaDevices||!("getUserMedia"in navigator.mediaDevices))throw this._deviceErrorCallback&&this._deviceErrorCallback({devices:["mic","cam"],type:"undefined-mediadevices"}),new Error("Could not request user media");t=t??this.deviceSelection?.deviceId;try{const o={audio:!0};t&&(o.audio={deviceId:{exact:t}}),this.stream=await navigator.mediaDevices.getUserMedia(o)}catch(o){throw this._deviceErrorCallback&&this._deviceErrorCallback({devices:["mic"],type:"unknown",error:o}),new Error("Could not start media stream")}this.listDevices().then(o=>{t=this.stream.getAudioTracks()[0].getSettings().deviceId,console.log("find current device",o,t,this.stream.getAudioTracks()[0].getSettings()),this.deviceSelection=o.find(u=>u.deviceId===t),console.log("current device",this.deviceSelection)});const e=new AudioContext({sampleRate:this.sampleRate}),r=e.createMediaStreamSource(this.stream);try{await e.audioWorklet.addModule(this.scriptSrc)}catch(o){throw console.error(o),new Error(`Could not add audioWorklet module: ${this.scriptSrc}`)}const n=new AudioWorkletNode(e,"audio_processor");n.port.onmessage=o=>{const{event:u,id:c,data:l}=o.data;if(u==="receipt")this.eventReceipts[c]=l;else if(u==="chunk")if(this._chunkProcessorSize){const d=this._chunkProcessorBuffer;this._chunkProcessorBuffer={raw:E.mergeBuffers(d.raw,l.raw),mono:E.mergeBuffers(d.mono,l.mono)},this._chunkProcessorBuffer.mono.byteLength>=this._chunkProcessorSize&&(this._chunkProcessor(this._chunkProcessorBuffer),this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)})}else this._chunkProcessor(l)};const a=r.connect(n),s=e.createAnalyser();return s.fftSize=8192,s.smoothingTimeConstant=.1,a.connect(s),this.outputToSpeakers&&(console.warn(`Warning: Output to speakers may affect sound quality,
especially due to system audio feedback preventative measures.
use only for debugging`),s.connect(e.destination)),this.source=r,this.node=a,this.analyser=s,this.processor=n,console.log("begin completed"),!0}getFrequencies(t="frequency",e=-100,r=-30){if(!this.processor)throw new Error("Session ended: please call .begin() first");return H.getFrequencies(this.analyser,this.sampleRate,null,t,e,r)}async pause(){if(this.processor){if(!this.recording)throw new Error("Already paused: please call .record() first")}else throw new Error("Session ended: please call .begin() first");return this._chunkProcessorBuffer.raw.byteLength&&this._chunkProcessor(this._chunkProcessorBuffer),this.log("Pausing ..."),await this._event("stop"),this.recording=!1,!0}async record(t=()=>{},e=8192){if(this.processor){if(this.recording)throw new Error("Already recording: please call .pause() first");if(typeof t!="function")throw new Error("chunkProcessor must be a function")}else throw new Error("Session ended: please call .begin() first");return this._chunkProcessor=t,this._chunkProcessorSize=e,this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)},this.log("Recording ..."),await this._event("start"),this.recording=!0,!0}async clear(){if(!this.processor)throw new Error("Session ended: please call .begin() first");return await this._event("clear"),!0}async read(){if(!this.processor)throw new Error("Session ended: please call .begin() first");return this.log("Reading ..."),await this._event("read")}async save(t=!1){if(!this.processor)throw new Error("Session ended: please call .begin() first");if(!t&&this.recording)throw new Error("Currently recording: please call .pause() first, or call .save(true) to force");this.log("Exporting ...");const e=await this._event("export");return new E().pack(this.sampleRate,e.audio)}async end(){if(!this.processor)throw new Error("Session ended: please call .begin() first");const t=this.processor;this.log("Stopping ..."),await this._event("stop"),this.recording=!1,this.stream.getTracks().forEach(s=>s.stop()),this.log("Exporting ...");const r=await this._event("export",{},t);return this.processor.disconnect(),this.source.disconnect(),this.node.disconnect(),this.analyser.disconnect(),this.stream=null,this.processor=null,this.source=null,this.node=null,new E().pack(this.sampleRate,r.audio)}async quit(){return this.listenForDeviceChange(null),this.deviceSelection=null,this.processor&&await this.end(),!0}}globalThis.WavRecorder=ai;function La(i,t,e){if(t===e)return i;const r=new Int16Array(i),n=t/e,a=Math.round(r.length/n),s=new ArrayBuffer(a*2),o=new Int16Array(s);for(let u=0;u<a;u++){const c=u*n,l=Math.floor(c),d=Math.min(l+1,r.length-1),h=c-l;o[u]=Math.round(r[l]*(1-h)+r[d]*h)}return s}class fo{constructor({sampleRate:t=44100,outputToSpeakers:e=!1,debug:r=!1}={}){this.scriptSrc=ni,this.sampleRate=t,this.outputToSpeakers=e,this.debug=!!r,this.stream=null,this.processor=null,this.source=null,this.node=null,this.recording=!1,this._lastEventId=0,this.eventReceipts={},this.eventTimeout=5e3,this._chunkProcessor=()=>{},this._chunkProcessorSize=void 0,this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)}}log(){return this.debug&&this.log(...arguments),!0}getSampleRate(){return this.sampleRate}getStatus(){return this.processor?this.recording?"recording":"paused":"ended"}async _event(t,e={},r=null){if(r=r||this.processor,!r)throw new Error("Can not send events without recording first");const n={event:t,id:this._lastEventId++,data:e};r.port.postMessage(n);const a=new Date().valueOf();for(;!this.eventReceipts[n.id];){if(new Date().valueOf()-a>this.eventTimeout)throw new Error(`Timeout waiting for "${t}" event`);await new Promise(o=>setTimeout(()=>o(!0),1))}const s=this.eventReceipts[n.id];return delete this.eventReceipts[n.id],s}async begin(t){if(this.processor)throw new Error("Already connected: please call .end() to start a new session");if(!t||t.kind!=="audio")throw new Error("No audio track provided");this.stream=new MediaStream([t]);const e=navigator.userAgent.toLowerCase().includes("firefox");let r;e?r=new AudioContext:r=new AudioContext({sampleRate:this.sampleRate});const n=r.sampleRate,a=r.createMediaStreamSource(this.stream);try{await r.audioWorklet.addModule(this.scriptSrc)}catch(c){throw console.error(c),new Error(`Could not add audioWorklet module: ${this.scriptSrc}`)}const s=new AudioWorkletNode(r,"audio_processor");s.port.onmessage=c=>{const{event:l,id:d,data:h}=c.data;if(l==="receipt")this.eventReceipts[d]=h;else if(l==="chunk"){const v={raw:La(h.raw,n,this.sampleRate),mono:La(h.mono,n,this.sampleRate)};if(this._chunkProcessorSize){const f=this._chunkProcessorBuffer;this._chunkProcessorBuffer={raw:E.mergeBuffers(f.raw,v.raw),mono:E.mergeBuffers(f.mono,v.mono)},this._chunkProcessorBuffer.mono.byteLength>=this._chunkProcessorSize&&(this._chunkProcessor(this._chunkProcessorBuffer),this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)})}else this._chunkProcessor(v)}};const o=a.connect(s),u=r.createAnalyser();return u.fftSize=8192,u.smoothingTimeConstant=.1,o.connect(u),this.outputToSpeakers&&(console.warn(`Warning: Output to speakers may affect sound quality,
especially due to system audio feedback preventative measures.
use only for debugging`),u.connect(r.destination)),this.source=a,this.node=o,this.analyser=u,this.processor=s,!0}getFrequencies(t="frequency",e=-100,r=-30){if(!this.processor)throw new Error("Session ended: please call .begin() first");return H.getFrequencies(this.analyser,this.sampleRate,null,t,e,r)}async pause(){if(this.processor){if(!this.recording)throw new Error("Already paused: please call .record() first")}else throw new Error("Session ended: please call .begin() first");return this._chunkProcessorBuffer.raw.byteLength&&this._chunkProcessor(this._chunkProcessorBuffer),this.log("Pausing ..."),await this._event("stop"),this.recording=!1,!0}async record(t=()=>{},e=8192){if(this.processor){if(this.recording)throw new Error("Already recording: HELLO please call .pause() first");if(typeof t!="function")throw new Error("chunkProcessor must be a function")}else throw new Error("Session ended: please call .begin() first");return this._chunkProcessor=t,this._chunkProcessorSize=e,this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)},this.log("Recording ..."),await this._event("start"),this.recording=!0,!0}async clear(){if(!this.processor)throw new Error("Session ended: please call .begin() first");return await this._event("clear"),!0}async read(){if(!this.processor)throw new Error("Session ended: please call .begin() first");return this.log("Reading ..."),await this._event("read")}async save(t=!1){if(!this.processor)throw new Error("Session ended: please call .begin() first");if(!t&&this.recording)throw new Error("Currently recording: please call .pause() first, or call .save(true) to force");this.log("Exporting ...");const e=await this._event("export");return new E().pack(this.sampleRate,e.audio)}async end(){if(!this.processor)throw new Error("Session ended: please call .begin() first");const t=this.processor;this.log("Stopping ..."),await this._event("stop"),this.recording=!1,this.log("Exporting ...");const e=await this._event("export",{},t);return this.processor.disconnect(),this.source.disconnect(),this.node.disconnect(),this.analyser.disconnect(),this.stream=null,this.processor=null,this.source=null,this.node=null,new E().pack(this.sampleRate,e.audio)}async quit(){return this.listenForDeviceChange(null),this.processor&&await this.end(),!0}}globalThis.WavRecorder=WavRecorder;var po=(function(){var i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(r[a]=n[a])},i(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(t,e);function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}})(),U=function(i,t,e,r){function n(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function o(l){try{c(r.next(l))}catch(d){s(d)}}function u(l){try{c(r.throw(l))}catch(d){s(d)}}function c(l){l.done?a(l.value):n(l.value).then(o,u)}c((r=r.apply(i,t||[])).next())})},V=function(i,t){var e={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,n,a,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(c){return function(l){return u([c,l])}}function u(c){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(e=0)),e;)try{if(r=1,n&&(a=c[0]&2?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[c[0]&2,a.value]),c[0]){case 0:case 1:a=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,n=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(a=e.trys,!(a=a.length>0&&a[a.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!a||c[1]>a[0]&&c[1]<a[3])){e.label=c[1];break}if(c[0]===6&&e.label<a[1]){e.label=a[1],a=c;break}if(a&&e.label<a[2]){e.label=a[2],e.ops.push(c);break}a[2]&&e.ops.pop(),e.trys.pop();continue}c=t.call(i,e)}catch(l){c=[6,l],n=0}finally{r=a=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}},ii=(function(){function i(){this._callbacks={},this._micEnabled=!0,this._camEnabled=!1,this._supportsScreenShare=!1}return i.prototype.setUserAudioCallback=function(t){this._userAudioCallback=t},i.prototype.setClientOptions=function(t,e){var r,n,a;e===void 0&&(e=!1),!(this._options&&!e)&&(this._options=t,this._callbacks=(r=t.callbacks)!==null&&r!==void 0?r:{},this._micEnabled=(n=t.enableMic)!==null&&n!==void 0?n:!0,this._camEnabled=(a=t.enableCam)!==null&&a!==void 0?a:!1)},Object.defineProperty(i.prototype,"supportsScreenShare",{get:function(){return this._supportsScreenShare},enumerable:!1,configurable:!0}),i})();(function(i){po(t,i);function t(e,r){e===void 0&&(e=void 0),r===void 0&&(r=24e3);var n=i.call(this)||this;return n._initialized=!1,n._recorderChunkSize=void 0,n._recorderChunkSize=e,n._wavRecorder=new ai({sampleRate:r}),n._wavStreamPlayer=new Rr({sampleRate:24e3}),n}return t.prototype.initialize=function(){return U(this,void 0,Promise,function(){return V(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this._wavRecorder.begin()];case 1:return e.sent(),[3,3];case 2:return e.sent(),[3,3];case 3:return this._wavRecorder.listenForDeviceChange(null),this._wavRecorder.listenForDeviceChange(this._handleAvailableDevicesUpdated.bind(this)),this._wavRecorder.listenForDeviceErrors(null),this._wavRecorder.listenForDeviceErrors(this._handleDeviceError.bind(this)),[4,this._wavStreamPlayer.connect()];case 4:return e.sent(),this._initialized=!0,[2]}})})},t.prototype.connect=function(){return U(this,void 0,Promise,function(){var e;return V(this,function(r){switch(r.label){case 0:return this._initialized?[3,2]:[4,this.initialize()];case 1:r.sent(),r.label=2;case 2:return e=this._wavRecorder.getStatus()=="recording",this._micEnabled&&!e?[4,this._startRecording()]:[3,4];case 3:r.sent(),r.label=4;case 4:return this._camEnabled&&console.warn("WavMediaManager does not support video input."),[2]}})})},t.prototype.disconnect=function(){return U(this,void 0,Promise,function(){return V(this,function(e){switch(e.label){case 0:return this._initialized?[4,this._wavRecorder.end()]:[2];case 1:return e.sent(),[4,this._wavStreamPlayer.interrupt()];case 2:return e.sent(),this._initialized=!1,[2]}})})},t.prototype.userStartedSpeaking=function(){return U(this,void 0,Promise,function(){return V(this,function(e){return[2,this._wavStreamPlayer.interrupt()]})})},t.prototype.bufferBotAudio=function(e,r){return this._wavStreamPlayer.add16BitPCM(e,r)},t.prototype.getAllMics=function(){return this._wavRecorder.listDevices()},t.prototype.getAllCams=function(){return Promise.resolve([])},t.prototype.getAllSpeakers=function(){return Promise.resolve([])},t.prototype.updateMic=function(e){return U(this,void 0,Promise,function(){var r,n,a,s;return V(this,function(o){switch(o.label){case 0:return r=this._wavRecorder.deviceSelection,this._wavRecorder.getStatus()==="ended"?[3,2]:[4,this._wavRecorder.end()];case 1:o.sent(),o.label=2;case 2:return o.trys.push([2,6,,7]),[4,this._wavRecorder.begin(e)];case 3:return o.sent(),this._micEnabled?[4,this._startRecording()]:[3,5];case 4:o.sent(),o.label=5;case 5:return n=this._wavRecorder.deviceSelection,n&&r&&r.label!==n.label&&((s=(a=this._callbacks).onMicUpdated)===null||s===void 0||s.call(a,n)),[3,7];case 6:return o.sent(),[3,7];case 7:return[2]}})})},t.prototype.updateCam=function(e){},t.prototype.updateSpeaker=function(e){},Object.defineProperty(t.prototype,"selectedMic",{get:function(){var e;return(e=this._wavRecorder.deviceSelection)!==null&&e!==void 0?e:{}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedCam",{get:function(){return{}},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedSpeaker",{get:function(){return{}},enumerable:!1,configurable:!0}),t.prototype.enableMic=function(e){return U(this,void 0,Promise,function(){var r=this;return V(this,function(n){switch(n.label){case 0:return this._micEnabled=e,this._wavRecorder.stream?(this._wavRecorder.stream.getAudioTracks().forEach(function(a){var s,o;a.enabled=e,e||(o=(s=r._callbacks).onTrackStopped)===null||o===void 0||o.call(s,a,Ba())}),e?[4,this._startRecording()]:[3,2]):[2];case 1:return n.sent(),[3,4];case 2:return[4,this._wavRecorder.pause()];case 3:n.sent(),n.label=4;case 4:return[2]}})})},t.prototype.enableCam=function(e){console.warn("WavMediaManager does not support video input.")},t.prototype.enableScreenShare=function(e){console.warn("WavMediaManager does not support screen sharing.")},Object.defineProperty(t.prototype,"isCamEnabled",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isMicEnabled",{get:function(){return this._micEnabled},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isSharingScreen",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.tracks=function(){var e,r=(e=this._wavRecorder.stream)===null||e===void 0?void 0:e.getTracks()[0];return{local:r?{audio:r}:{}}},t.prototype._startRecording=function(){return U(this,void 0,void 0,function(){var e,r=this,n,a,s;return V(this,function(o){switch(o.label){case 0:return[4,this._wavRecorder.record(function(u){var c;(c=r._userAudioCallback)===null||c===void 0||c.call(r,u.mono)},this._recorderChunkSize)];case 1:return o.sent(),e=(n=this._wavRecorder.stream)===null||n===void 0?void 0:n.getAudioTracks()[0],e&&((s=(a=this._callbacks).onTrackStarted)===null||s===void 0||s.call(a,e,Ba())),[2]}})})},t.prototype._handleAvailableDevicesUpdated=function(e){var r,n,a,s;(n=(r=this._callbacks).onAvailableCamsUpdated)===null||n===void 0||n.call(r,e.filter(function(c){return c.kind==="videoinput"})),(s=(a=this._callbacks).onAvailableMicsUpdated)===null||s===void 0||s.call(a,e.filter(function(c){return c.kind==="audioinput"}));var o=e.find(function(c){return c.deviceId==="default"}),u=this._wavRecorder.deviceSelection;u&&(!e.some(function(c){return c.deviceId===u.deviceId})||u.deviceId==="default"&&u.label!==o?.label)&&this.updateMic("")},t.prototype._handleDeviceError=function(e){var r,n,a=e.devices,s=e.type,o=e.error,u=new j(a,s,o?.message,o?{sourceError:o}:void 0);(n=(r=this._callbacks).onDeviceError)===null||n===void 0||n.call(r,u)},t})(ii);var Ba=function(){return{id:"local",name:"",local:!0}},vo=(function(){var i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(r[a]=n[a])},i(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");i(t,e);function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}})(),I=function(i,t,e,r){function n(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function o(l){try{c(r.next(l))}catch(d){s(d)}}function u(l){try{c(r.throw(l))}catch(d){s(d)}}function c(l){l.done?a(l.value):n(l.value).then(o,u)}c((r=r.apply(i,t||[])).next())})},M=function(i,t){var e={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,n,a,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(c){return function(l){return u([c,l])}}function u(c){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(e=0)),e;)try{if(r=1,n&&(a=c[0]&2?n.return:c[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,c[1])).done)return a;switch(n=0,a&&(c=[c[0]&2,a.value]),c[0]){case 0:case 1:a=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,n=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(a=e.trys,!(a=a.length>0&&a[a.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!a||c[1]>a[0]&&c[1]<a[3])){e.label=c[1];break}if(c[0]===6&&e.label<a[1]){e.label=a[1],a=c;break}if(a&&e.label<a[2]){e.label=a[2],e.ops.push(c);break}a[2]&&e.ops.pop(),e.trys.pop();continue}c=t.call(i,e)}catch(l){c=[6,l],n=0}finally{r=a=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}},go=(function(i){vo(t,i);function t(e,r,n,a,s,o,u){e===void 0&&(e=!0),r===void 0&&(r=!0),s===void 0&&(s=void 0),o===void 0&&(o=24e3),u===void 0&&(u=24e3);var c,l=i.call(this)||this;return l._selectedCam={},l._selectedMic={},l._selectedSpeaker={},l._remoteAudioLevelInterval=null,l._recorderChunkSize=void 0,l._initialized=!1,l._connected=!1,l._currentAudioTrack=null,l._connectResolve=null,l.onTrackStartedCallback=n,l.onTrackStoppedCallback=a,l._recorderChunkSize=s,l._supportsScreenShare=!0,l._daily=(c=Or.getCallInstance())!==null&&c!==void 0?c:Or.createCallObject(),r&&(l._mediaStreamRecorder=new fo({sampleRate:o})),e&&(l._wavStreamPlayer=new Rr({sampleRate:u})),l._daily.on("track-started",l.handleTrackStarted.bind(l)),l._daily.on("track-stopped",l.handleTrackStopped.bind(l)),l._daily.on("available-devices-updated",l._handleAvailableDevicesUpdated.bind(l)),l._daily.on("selected-devices-updated",l._handleSelectedDevicesUpdated.bind(l)),l._daily.on("camera-error",l.handleDeviceError.bind(l)),l._daily.on("local-audio-level",l._handleLocalAudioLevel.bind(l)),l}return t.prototype.initialize=function(){return I(this,void 0,Promise,function(){var e,r,n,a,s,o=this,u,c,l,d,h,v,f,g,w,C,y,S;return M(this,function(A){switch(A.label){case 0:return this._initialized?(console.warn("DailyMediaManager already initialized"),[2]):[4,this._daily.startCamera({startVideoOff:!this._camEnabled,startAudioOff:!this._micEnabled,dailyConfig:{useDevicePreferenceCookies:!0}})];case 1:return e=A.sent(),[4,this._daily.enumerateDevices()];case 2:return r=A.sent().devices,n=r.filter(function(k){return k.kind==="videoinput"}),a=r.filter(function(k){return k.kind==="audioinput"}),s=r.filter(function(k){return k.kind==="audiooutput"}),(c=(u=this._callbacks).onAvailableCamsUpdated)===null||c===void 0||c.call(u,n),(d=(l=this._callbacks).onAvailableMicsUpdated)===null||d===void 0||d.call(l,a),(v=(h=this._callbacks).onAvailableSpeakersUpdated)===null||v===void 0||v.call(h,s),this._selectedCam=e.camera,(g=(f=this._callbacks).onCamUpdated)===null||g===void 0||g.call(f,e.camera),this._selectedMic=e.mic,(C=(w=this._callbacks).onMicUpdated)===null||C===void 0||C.call(w,e.mic),this._selectedSpeaker=e.speaker,(S=(y=this._callbacks).onSpeakerUpdated)===null||S===void 0||S.call(y,e.speaker),this._daily.isLocalAudioLevelObserverRunning()?[3,4]:[4,this._daily.startLocalAudioLevelObserver(100)];case 3:A.sent(),A.label=4;case 4:return this._wavStreamPlayer?[4,this._wavStreamPlayer.connect()]:[3,6];case 5:A.sent(),this._remoteAudioLevelInterval||(this._remoteAudioLevelInterval=setInterval(function(){var k,T=o._wavStreamPlayer.getFrequencies(),x=0;!((k=T.values)===null||k===void 0)&&k.length&&(x=T.values.reduce(function(B,R){return B+R},0)/T.values.length),o._handleRemoteAudioLevel(x)},100)),A.label=6;case 6:return this._initialized=!0,[2]}})})},t.prototype.connect=function(){return I(this,void 0,Promise,function(){var e=this;return M(this,function(r){return this._connected?(console.warn("DailyMediaManager already connected"),[2]):(this._connected=!0,this._initialized?(this._micEnabled&&this._startRecording(),[2]):[2,new Promise(function(n){(function(){return I(e,void 0,void 0,function(){return M(this,function(a){switch(a.label){case 0:return this._connectResolve=n,[4,this.initialize()];case 1:return a.sent(),[2]}})})})()})])})})},t.prototype.disconnect=function(){return I(this,void 0,Promise,function(){var e,r;return M(this,function(n){switch(n.label){case 0:return this._remoteAudioLevelInterval&&clearInterval(this._remoteAudioLevelInterval),this._remoteAudioLevelInterval=null,this._daily.leave(),this._currentAudioTrack=null,[4,(e=this._mediaStreamRecorder)===null||e===void 0?void 0:e.end()];case 1:return n.sent(),(r=this._wavStreamPlayer)===null||r===void 0||r.interrupt(),this._initialized=!1,this._connected=!1,[2]}})})},t.prototype.userStartedSpeaking=function(){return I(this,void 0,Promise,function(){var e;return M(this,function(r){return[2,(e=this._wavStreamPlayer)===null||e===void 0?void 0:e.interrupt()]})})},t.prototype.bufferBotAudio=function(e,r){var n;return(n=this._wavStreamPlayer)===null||n===void 0?void 0:n.add16BitPCM(e,r)},t.prototype.getAllMics=function(){return I(this,void 0,Promise,function(){var e;return M(this,function(r){switch(r.label){case 0:return[4,this._daily.enumerateDevices()];case 1:return e=r.sent().devices,[2,e.filter(function(n){return n.kind==="audioinput"})]}})})},t.prototype.getAllCams=function(){return I(this,void 0,Promise,function(){var e;return M(this,function(r){switch(r.label){case 0:return[4,this._daily.enumerateDevices()];case 1:return e=r.sent().devices,[2,e.filter(function(n){return n.kind==="videoinput"})]}})})},t.prototype.getAllSpeakers=function(){return I(this,void 0,Promise,function(){var e;return M(this,function(r){switch(r.label){case 0:return[4,this._daily.enumerateDevices()];case 1:return e=r.sent().devices,[2,e.filter(function(n){return n.kind==="audiooutput"})]}})})},t.prototype.updateMic=function(e){var r=this;this._daily.setInputDevicesAsync({audioDeviceId:e}).then(function(n){r._selectedMic=n.mic})},t.prototype.updateCam=function(e){var r=this;this._daily.setInputDevicesAsync({videoDeviceId:e}).then(function(n){r._selectedCam=n.camera})},t.prototype.updateSpeaker=function(e){return I(this,void 0,Promise,function(){var r,n,a,s,o,u,c=this,l,d,h,v;return M(this,function(f){switch(f.label){case 0:if(this._wavStreamPlayer)return[3,5];f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this._daily.setOutputDeviceAsync({outputDeviceId:e})];case 2:return r=f.sent(),this._selectedSpeaker=r.speaker,(d=(l=this._callbacks).onSpeakerUpdated)===null||d===void 0||d.call(l,this._selectedSpeaker),[3,4];case 3:return n=f.sent(),console.error("Error setting output device",n),[3,4];case 4:return[2];case 5:return e!=="default"&&this._selectedSpeaker.deviceId===e?[2]:(a=e,a!=="default"?[3,7]:[4,this.getAllSpeakers()]);case 6:if(s=f.sent(),o=s.find(function(g){return g.deviceId==="default"}),!o)return console.warn("No default speaker found"),[2];s.splice(s.indexOf(o),1),u=s.find(function(g){return o.label.includes(g.label)}),a=(h=u?.deviceId)!==null&&h!==void 0?h:e,f.label=7;case 7:return(v=this._wavStreamPlayer)===null||v===void 0||v.updateSpeaker(a).then(function(){var g,w;c._selectedSpeaker={deviceId:e},(w=(g=c._callbacks).onSpeakerUpdated)===null||w===void 0||w.call(g,c._selectedSpeaker)}),[2]}})})},Object.defineProperty(t.prototype,"selectedMic",{get:function(){return this._selectedMic},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedCam",{get:function(){return this._selectedCam},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectedSpeaker",{get:function(){return this._selectedSpeaker},enumerable:!1,configurable:!0}),t.prototype.enableMic=function(e){return I(this,void 0,Promise,function(){var r;return M(this,function(n){return this._micEnabled=e,!((r=this._daily.participants())===null||r===void 0)&&r.local?(this._daily.setLocalAudio(e),this._mediaStreamRecorder&&(e?this._mediaStreamRecorder.getStatus()==="paused"&&this._startRecording():this._mediaStreamRecorder.getStatus()==="recording"&&this._mediaStreamRecorder.pause()),[2]):[2]})})},t.prototype.enableCam=function(e){this._camEnabled=e,this._daily.setLocalVideo(e)},t.prototype.enableScreenShare=function(e){e?this._daily.startScreenShare():this._daily.stopScreenShare()},Object.defineProperty(t.prototype,"isCamEnabled",{get:function(){return this._daily.localVideo()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isMicEnabled",{get:function(){return this._daily.localAudio()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isSharingScreen",{get:function(){return this._daily.localScreenAudio()||this._daily.localScreenVideo()},enumerable:!1,configurable:!0}),t.prototype.tracks=function(){var e,r,n,a,s,o,u,c,l,d,h,v,f=this._daily.participants();return{local:{audio:(n=(r=(e=f?.local)===null||e===void 0?void 0:e.tracks)===null||r===void 0?void 0:r.audio)===null||n===void 0?void 0:n.persistentTrack,screenAudio:(o=(s=(a=f?.local)===null||a===void 0?void 0:a.tracks)===null||s===void 0?void 0:s.screenAudio)===null||o===void 0?void 0:o.persistentTrack,screenVideo:(l=(c=(u=f?.local)===null||u===void 0?void 0:u.tracks)===null||c===void 0?void 0:c.screenVideo)===null||l===void 0?void 0:l.persistentTrack,video:(v=(h=(d=f?.local)===null||d===void 0?void 0:d.tracks)===null||h===void 0?void 0:h.video)===null||v===void 0?void 0:v.persistentTrack}}},t.prototype._startRecording=function(){var e=this;if(!(!this._connected||!this._mediaStreamRecorder))try{this._mediaStreamRecorder.record(function(n){e._userAudioCallback(n.mono)},this._recorderChunkSize)}catch(n){var r=n;r.message.includes("Already recording")||console.error("Error starting recording",n)}},t.prototype._handleAvailableDevicesUpdated=function(e){var r,n,a,s,o,u;(n=(r=this._callbacks).onAvailableCamsUpdated)===null||n===void 0||n.call(r,e.availableDevices.filter(function(c){return c.kind==="videoinput"})),(s=(a=this._callbacks).onAvailableMicsUpdated)===null||s===void 0||s.call(a,e.availableDevices.filter(function(c){return c.kind==="audioinput"})),(u=(o=this._callbacks).onAvailableSpeakersUpdated)===null||u===void 0||u.call(o,e.availableDevices.filter(function(c){return c.kind==="audiooutput"})),this._selectedSpeaker.deviceId==="default"&&this.updateSpeaker("default")},t.prototype._handleSelectedDevicesUpdated=function(e){var r,n,a,s,o,u;((r=this._selectedCam)===null||r===void 0?void 0:r.deviceId)!==e.devices.camera&&(this._selectedCam=e.devices.camera,(a=(n=this._callbacks).onCamUpdated)===null||a===void 0||a.call(n,e.devices.camera)),((s=this._selectedMic)===null||s===void 0?void 0:s.deviceId)!==e.devices.mic&&(this._selectedMic=e.devices.mic,(u=(o=this._callbacks).onMicUpdated)===null||u===void 0||u.call(o,e.devices.mic))},t.prototype.handleDeviceError=function(e){var r,n,a=function(s){var o=[];switch(s.type){case"permissions":return s.blockedMedia.forEach(function(u){o.push(u==="video"?"cam":"mic")}),new j(o,s.type,s.msg,{blockedBy:s.blockedBy});case"not-found":return s.missingMedia.forEach(function(u){o.push(u==="video"?"cam":"mic")}),new j(o,s.type,s.msg);case"constraints":return s.failedMedia.forEach(function(u){o.push(u==="video"?"cam":"mic")}),new j(o,s.type,s.msg,{reason:s.reason});case"cam-in-use":return o.push("cam"),new j(o,"in-use",s.msg);case"mic-in-use":return o.push("mic"),new j(o,"in-use",s.msg);case"cam-mic-in-use":return o.push("cam"),o.push("mic"),new j(o,"in-use",s.msg);case"undefined-mediadevices":case"unknown":default:return o.push("cam"),o.push("mic"),new j(o,s.type,s.msg)}};(n=(r=this._callbacks).onDeviceError)===null||n===void 0||n.call(r,a(e.error))},t.prototype._handleLocalAudioLevel=function(e){var r,n;(n=(r=this._callbacks).onLocalAudioLevel)===null||n===void 0||n.call(r,e.audioLevel)},t.prototype._handleRemoteAudioLevel=function(e){var r,n;(n=(r=this._callbacks).onRemoteAudioLevel)===null||n===void 0||n.call(r,e,_o())},t.prototype.handleTrackStarted=function(e){return I(this,void 0,void 0,function(){var r,n,a,s,o,u;return M(this,function(c){switch(c.label){case 0:if(!(!((a=e.participant)===null||a===void 0)&&a.local))return[2];if(e.track.kind!=="audio")return[3,15];if(!this._mediaStreamRecorder)return[3,14];switch(r=this._mediaStreamRecorder.getStatus(),n=r,n){case"ended":return[3,1];case"paused":return[3,5];case"recording":return[3,6]}return[3,6];case 1:return c.trys.push([1,3,,4]),[4,this._mediaStreamRecorder.begin(e.track)];case 2:return c.sent(),this._connected&&(this._startRecording(),this._connectResolve&&(this._connectResolve(),this._connectResolve=null)),[3,4];case 3:return c.sent(),[3,4];case 4:return[3,14];case 5:return this._startRecording(),[3,14];case 6:return this._currentAudioTrack===e.track?[3,12]:[4,this._mediaStreamRecorder.end()];case 7:c.sent(),c.label=8;case 8:return c.trys.push([8,10,,11]),[4,this._mediaStreamRecorder.begin(e.track)];case 9:return c.sent(),this._startRecording(),[3,11];case 10:return c.sent(),[3,11];case 11:return[3,13];case 12:console.warn("track-started event received for current track and already recording"),c.label=13;case 13:return[3,14];case 14:this._currentAudioTrack=e.track,c.label=15;case 15:return(o=(s=this._callbacks).onTrackStarted)===null||o===void 0||o.call(s,e.track,e.participant?Fa(e.participant):void 0),(u=this.onTrackStartedCallback)===null||u===void 0||u.call(this,e),[2]}})})},t.prototype.handleTrackStopped=function(e){var r,n,a,s;!((r=e.participant)===null||r===void 0)&&r.local&&(e.track.kind==="audio"&&this._mediaStreamRecorder&&this._mediaStreamRecorder.getStatus()==="recording"&&this._mediaStreamRecorder.pause(),(a=(n=this._callbacks).onTrackStopped)===null||a===void 0||a.call(n,e.track,e.participant?Fa(e.participant):void 0),(s=this.onTrackStoppedCallback)===null||s===void 0||s.call(this,e))},t})(ii),Fa=function(i){return{id:i.user_id,local:i.local,name:i.user_name}},_o=function(){return{id:"bot",local:!1,name:"Bot"}},bo={};ro(bo,"SmallWebRTCTransport",()=>oi);class W{constructor(t,e){this.type="trackStatus",this.receiver_index=t,this.enabled=e}}class yo{constructor(t){this.track=t,this.status="new"}}const mo="renegotiate",wo="peerLeft",si="signalling";class So{constructor(t){this.type=si,this.message=t}}const dr=0,hr=1,fr=2;class oi extends Ei{constructor(t={}){super(),this._webrtcRequest=null,this._connectResolved=null,this._connectFailed=null,this.pc=null,this.dc=null,this.audioCodec=null,this.videoCodec=null,this.pc_id=null,this.offerUrlTemplate=null,this.reconnectionAttempts=0,this.maxReconnectionAttempts=3,this.isReconnecting=!1,this.keepAliveInterval=null,this._iceServers=[],this._incomingTracks=new Map,this._canSendIceCandidates=!1,this._candidateQueue=[],this.__flushTimeout=null,this._flushDelay=200,this._iceServers=t.iceServers??[],this._waitForICEGathering=t.waitForICEGathering??!1,this.audioCodec=t.audioCodec??null,this.videoCodec=t.videoCodec??null,this.offerUrlTemplate=t.offerUrlTemplate??null,this._webrtcRequest=this._resolveRequestInfo(t),this.mediaManager=t.mediaManager||new go(!1,!1,async e=>{this.pc&&(e.type=="audio"?(p.info("SmallWebRTCMediaManager replacing audio track"),await this.getAudioTransceiver().sender.replaceTrack(e.track)):e.type=="video"?(p.info("SmallWebRTCMediaManager replacing video track"),await this.getVideoTransceiver().sender.replaceTrack(e.track)):e.type=="screenVideo"?(p.info("SmallWebRTCMediaManager replacing screen video track"),await this.getScreenVideoTransceiver().sender.replaceTrack(e.track)):e.type=="screenAudio"&&p.info("SmallWebRTCMediaManager does not yet support screen audio. Track is ignored."))},e=>p.debug("SmallWebRTCMediaManager Track stopped:",e))}initialize(t,e){this._options=t,this._callbacks=t.callbacks??{},this._onMessage=e,this.mediaManager.setClientOptions(t),this.state="disconnected",p.debug("[RTVI Transport] Initialized")}async initDevices(){this.state="initializing",await this.mediaManager.initialize(),this.state="initialized"}setAudioCodec(t){this.audioCodec=t}setVideoCodec(t){this.videoCodec=t}_resolveRequestInfo(t){let e=null;const r=t.webrtcUrl??t.connectionUrl??null;if(r){const n=t.webrtcUrl?"webrtcUrl":"connectionUrl";p.warn(`${n} is deprecated. Use webrtcRequestParams instead.`),t.webrtcRequestParams?p.warn(`Both ${n} and webrtcRequestParams provided. Using webrtcRequestParams.`):typeof r=="string"?e={endpoint:r}:p.error(`Invalid ${n} provided in params. Ignoring.`)}return t.webrtcRequestParams&&(Pi(t.webrtcRequestParams)?e=t.webrtcRequestParams:p.error("Invalid webrtcRequestParams provided in params. Ignoring.")),e??this._webrtcRequest}_getStartEndpointAsString(){const t=this.startBotParams?.endpoint;switch(typeof t){case"string":return t;case"object":if(t instanceof URL)return t.toString();if(typeof Request<"u"&&t instanceof Request)return t.url}}_isValidObject(t){if(t==null)return!1;if(typeof t!="object")throw new xi("Invalid connection parameters");return!0}_fixConnectionOptionsParams(t,e){const r=s=>s.replace(/_([a-z,A-Z])/g,(o,u)=>u.toUpperCase());let n={},a;for(const[s,o]of Object.entries(t)){const u=r(s);if(u==="sessionId"){a=o;continue}if(!e.includes(u)){p.warn(`Unrecognized connection parameter: ${s}. Ignored.`);continue}n[u]=o}return a&&this._shouldUseStartBotFallback(n)&&(n.webrtcRequestParams=this._buildRequestParamsBasedOnStartBotParams(a)),n}_shouldUseStartBotFallback(t){const e=!!this._getStartEndpointAsString(),r=!t.webrtcUrl&&!t.connectionUrl&&!t.webrtcRequestParams;return e&&r}_buildRequestParamsBasedOnStartBotParams(t){const e=this._getStartEndpointAsString(),r=this.offerUrlTemplate?this.offerUrlTemplate.replace(":sessionId",t):e.replace("/start",`/sessions/${t}/api/offer`);return typeof Request<"u"&&this.startBotParams.endpoint instanceof Request?{endpoint:new Request(r,this.startBotParams?.endpoint)}:{endpoint:r,headers:this.startBotParams.headers}}_validateConnectionParams(t){if(!this._isValidObject(t))return;const e=t,r=["webrtcUrl","connectionUrl","webrtcRequestParams","iceConfig"],n=this._fixConnectionOptionsParams(e,r),a=this._resolveRequestInfo(n);if(a&&(n.webrtcRequestParams=a),delete n.connectionUrl,delete n.webrtcUrl,Object.keys(n).length!==0)return n}async _connect(t){if(!this._abortController?.signal.aborted){if(this.state="connecting",t?.iceConfig?.iceServers&&(this._iceServers=t?.iceConfig?.iceServers),this._webrtcRequest=t?.webrtcRequestParams??this._webrtcRequest,!this._webrtcRequest)throw p.error("No request details provided for WebRTC connection"),this.state="error",new xr;await this.mediaManager.connect(),await this.startNewPeerConnection(),!this._abortController?.signal.aborted&&(this.dc?.readyState!=="open"&&await new Promise((e,r)=>{this._connectResolved=e,this._connectFailed=r}),this.state="connected",this._callbacks.onConnected?.())}}syncTrackStatus(){this.sendSignallingMessage(new W(dr,this.mediaManager.isMicEnabled)),this.sendSignallingMessage(new W(hr,this.mediaManager.isCamEnabled)),this.mediaManager.supportsScreenShare&&this.sendSignallingMessage(new W(fr,this.mediaManager.isSharingScreen&&!!this.mediaManager.tracks().local.screenVideo))}sendReadyMessage(){this.state="ready",this.sendMessage(Oi.clientReady())}sendMessage(t){if(!this.dc||this.dc.readyState!=="open"){p.warn(`Datachannel is not ready. Message not sent: ${t}`);return}this.dc?.send(JSON.stringify(t))}sendSignallingMessage(t){if(!this.dc||this.dc.readyState!=="open"){p.warn(`Datachannel is not ready. Message not sent: ${t}`);return}const e=new So(t);this.dc?.send(JSON.stringify(e))}async _disconnect(){this.state="disconnecting",await this.stop(),this.state="disconnected"}createPeerConnection(){const t={iceServers:this._iceServers};let e=new RTCPeerConnection(t);return e.onicecandidate=async r=>{r.candidate?(p.debug("New ICE candidate:",r.candidate),await this.sendIceCandidate(r.candidate)):p.info("All ICE candidates have been sent.")},e.addEventListener("icegatheringstatechange",()=>{e.iceGatheringState==="complete"&&e.iceConnectionState==="checking"&&this._waitForICEGathering&&(p.info("Ice gathering completed and connection is still checking. Trying to reconnect."),this.attemptReconnection(!1))}),e.addEventListener("iceconnectionstatechange",()=>this.handleICEConnectionStateChange()),p.debug(`iceConnectionState: ${e.iceConnectionState}`),e.addEventListener("signalingstatechange",()=>{p.debug(`signalingState: ${this.pc.signalingState}`),this.pc.signalingState=="stable"&&this.handleReconnectionCompleted()}),p.debug(`signalingState: ${e.signalingState}`),e.addEventListener("track",r=>{const n=r.transceiver?r.transceiver.mid==="0"?"microphone":r.transceiver.mid==="1"?"camera":"screenVideo":null;if(!n){p.warn("Received track without transceiver mid",r);return}p.debug(`Received new remote track for ${n}`),this._incomingTracks.set(n,new yo(r.track)),r.track.addEventListener("unmute",()=>{const a=this._incomingTracks.get(n);a&&(p.debug(`Remote track unmuted: ${n}`),a.status="unmuted",this._callbacks.onTrackStarted?.(r.track))}),r.track.addEventListener("mute",()=>{const a=this._incomingTracks.get(n);!a||a.status!=="unmuted"||(p.debug(`Remote track muted: ${n}`),a.status="muted",this._callbacks.onTrackStopped?.(r.track))}),r.track.addEventListener("ended",()=>{p.debug(`Remote track ended: ${n}`),this._callbacks.onTrackStopped?.(r.track),this._incomingTracks.delete(n)})}),e}handleICEConnectionStateChange(){this.pc&&(p.debug(`ICE Connection State: ${this.pc.iceConnectionState}`),this.pc.iceConnectionState==="failed"?(p.debug("ICE connection failed, attempting restart."),this.attemptReconnection(!0)):this.pc.iceConnectionState==="disconnected"&&setTimeout(()=>{this.pc?.iceConnectionState==="disconnected"&&(p.debug("Still disconnected, attempting reconnection."),this.attemptReconnection(!0))},5e3))}handleReconnectionCompleted(){this.reconnectionAttempts=0,this.isReconnecting=!1}async attemptReconnection(t=!1){if(this.isReconnecting){p.debug("Reconnection already in progress, skipping.");return}if(this.reconnectionAttempts>=this.maxReconnectionAttempts){p.debug("Max reconnection attempts reached. Stopping transport."),await this.stop();return}if(this.isReconnecting=!0,this.reconnectionAttempts++,p.debug(`Reconnection attempt ${this.reconnectionAttempts}...`),t){const e=this.pc;await this.startNewPeerConnection(t),e&&(p.debug("closing old peer connection"),this.closePeerConnection(e))}else await this.negotiate()}async waitForIceGatheringComplete(t=2e3){const e=this.pc;if(e.iceGatheringState!=="complete")return p.info("Waiting for ICE gathering to complete. Current state:",e.iceGatheringState),new Promise(r=>{let n;const a=()=>{e.removeEventListener("icegatheringstatechange",s),clearTimeout(n)},s=()=>{p.debug("icegatheringstatechange:",e.iceGatheringState),e.iceGatheringState==="complete"&&(a(),r())},o=()=>{p.debug(`ICE gathering timed out after ${t} ms.`),a(),r()};e.addEventListener("icegatheringstatechange",s),n=setTimeout(o,t),s()})}async sendIceCandidate(t){if(!this._webrtcRequest){p.error("No request details provided for WebRTC connection");return}this._candidateQueue.push(t),this.__flushTimeout||(this.__flushTimeout=setTimeout(()=>this.flushIceCandidates(),this._flushDelay))}async flushIceCandidates(){if(this.__flushTimeout=null,!this._webrtcRequest||this._candidateQueue.length===0||!this._canSendIceCandidates)return;const t=this._candidateQueue.splice(0,this._candidateQueue.length);let e;try{typeof Request<"u"&&this._webrtcRequest.endpoint instanceof Request?(console.log("Using Request object headers"),e=this._webrtcRequest.endpoint.headers):e=new Headers({"Content-Type":"application/json",...Object.fromEntries((this._webrtcRequest.headers??new Headers).entries())});const r={pc_id:this.pc_id,candidates:t.map(n=>({candidate:n.candidate,sdp_mid:n.sdpMid,sdp_mline_index:n.sdpMLineIndex}))};await fetch(this._webrtcRequest.endpoint,{method:"PATCH",headers:e,body:JSON.stringify(r)})}catch(r){p.error(`Failed to send ICE candidate: ${r}`)}}async negotiate(t=!1){if(!this.pc)return Promise.reject("Peer connection is not initialized");if(!this._webrtcRequest)throw p.error("No request details provided for WebRTC connection"),this.state="error",new xr;try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),this._waitForICEGathering&&await this.waitForIceGatheringComplete();let r=this.pc.localDescription;this.audioCodec&&this.audioCodec!=="default"&&(r.sdp=this.sdpFilterCodec("audio",this.audioCodec,r.sdp)),this.videoCodec&&this.videoCodec!=="default"&&(r.sdp=this.sdpFilterCodec("video",this.videoCodec,r.sdp)),p.debug(`Will create offer for peerId: ${this.pc_id}`);const n={sdp:r.sdp,type:r.type,pc_id:this.pc_id,restart_pc:t};let a;typeof Request<"u"&&this._webrtcRequest.endpoint instanceof Request?a={endpoint:new Request(this._webrtcRequest.endpoint,{body:JSON.stringify(n)})}:(a=to(this._webrtcRequest),this._webrtcRequest.requestData&&(n.requestData=this._webrtcRequest.requestData),a.requestData=n);const s=await $i(a);this.pc_id=s.pc_id,p.debug(`Received answer for peer connection id ${s.pc_id}`),await this.pc.setRemoteDescription(s)}catch(e){p.debug(`Reconnection attempt ${this.reconnectionAttempts} failed: ${e}`),this.isReconnecting=!1,setTimeout(()=>this.attemptReconnection(!0),2e3)}}addInitialTransceivers(){this.pc.addTransceiver("audio",{direction:"sendrecv"}),this.pc.addTransceiver("video",{direction:"sendrecv"}),this.mediaManager.supportsScreenShare&&this.pc.addTransceiver("video",{direction:"sendonly"})}getAudioTransceiver(){return this.pc.getTransceivers()[dr]}getVideoTransceiver(){return this.pc.getTransceivers()[hr]}getScreenVideoTransceiver(){return this.pc.getTransceivers()[fr]}async startNewPeerConnection(t=!1){this.pc=this.createPeerConnection(),this.addInitialTransceivers(),this.dc=this.createDataChannel("chat",{ordered:!0}),await this.addUserMedia(),await this.negotiate(t),this._canSendIceCandidates=!0,await this.flushIceCandidates()}async addUserMedia(){p.debug(`addUserMedia this.tracks(): ${this.tracks()}`);let t=this.tracks().local.audio;p.debug(`addUserMedia audioTrack: ${t}`),t&&await this.getAudioTransceiver().sender.replaceTrack(t);let e=this.tracks().local.video;p.debug(`addUserMedia videoTrack: ${e}`),e&&await this.getVideoTransceiver().sender.replaceTrack(e),this.mediaManager.supportsScreenShare&&(e=this.tracks().local.screenVideo,p.debug(`addUserMedia screenVideoTrack: ${e}`),e&&await this.getScreenVideoTransceiver().sender.replaceTrack(e))}handleMessage(t){try{const e=JSON.parse(t);p.debug("received message:",e),e.type===si?this.handleSignallingMessage(e):e.label==="rtvi-ai"&&this._onMessage({id:e.id,type:e.type,data:e.data})}catch(e){p.error("Failed to parse JSON message:",e)}}async handleSignallingMessage(t){const e=t;switch(e.message.type){case mo:this.attemptReconnection(!1);break;case wo:this.disconnect();break;default:p.warn("Unknown signalling message:",e.message)}}createDataChannel(t,e){const r=this.pc.createDataChannel(t,e);return r.addEventListener("close",()=>{p.debug("datachannel closed"),this.keepAliveInterval&&(clearInterval(this.keepAliveInterval),this.keepAliveInterval=null)}),r.addEventListener("open",()=>{p.debug("datachannel opened"),this._connectResolved&&(this.syncTrackStatus(),this._connectResolved(),this._connectResolved=null,this._connectFailed=null),this.keepAliveInterval=setInterval(()=>{const n="ping: "+new Date().getTime();r.send(n)},1e3)}),r.addEventListener("message",n=>{let a=n.data;this.handleMessage(a)}),r}closePeerConnection(t){t.getTransceivers().forEach(e=>{e.stop&&e.stop()}),t.getSenders().forEach(e=>{e.track?.stop()}),t.close()}async stop(){if(!this.pc){p.debug("Peer connection is already closed or null.");return}this.dc&&this.dc.close(),this.closePeerConnection(this.pc),this.pc=null,await this.mediaManager.disconnect(),this.pc_id=null,this.reconnectionAttempts=0,this.isReconnecting=!1,this._callbacks.onDisconnected?.(),this._candidateQueue=[],this._canSendIceCandidates=!1,this._connectFailed&&this._connectFailed(),this._connectFailed=null,this._connectResolved=null}getAllMics(){return this.mediaManager.getAllMics()}getAllCams(){return this.mediaManager.getAllCams()}getAllSpeakers(){return this.mediaManager.getAllSpeakers()}async updateMic(t){return this.mediaManager.updateMic(t)}updateCam(t){return this.mediaManager.updateCam(t)}updateSpeaker(t){return this.mediaManager.updateSpeaker(t)}get selectedMic(){return this.mediaManager.selectedMic}get selectedCam(){return this.mediaManager.selectedCam}get selectedSpeaker(){return this.mediaManager.selectedSpeaker}set iceServers(t){this._iceServers=t}get iceServers(){return this._iceServers}enableMic(t){this.mediaManager.enableMic(t),this.sendSignallingMessage(new W(dr,t))}enableCam(t){this.mediaManager.enableCam(t),this.sendSignallingMessage(new W(hr,t))}async enableScreenShare(t){if(!this.mediaManager.supportsScreenShare)throw new Di("enableScreenShare","mediaManager","Screen sharing is not supported by the current media manager");this.mediaManager.enableScreenShare(t),this.sendSignallingMessage(new W(fr,t))}get isCamEnabled(){return this.mediaManager.isCamEnabled}get isMicEnabled(){return this.mediaManager.isMicEnabled}get isSharingScreen(){return this.mediaManager.isSharingScreen}get state(){return this._state}set state(t){this._state!==t&&(this._state=t,this._callbacks.onTransportStateChanged?.(t))}tracks(){return this.mediaManager.tracks()}sdpFilterCodec(t,e,r){const n=[],a=new RegExp("a=fmtp:(\\d+) apt=(\\d+)\\r$"),s=new RegExp("a=rtpmap:([0-9]+) "+this.escapeRegExp(e)),o=new RegExp("(m="+t+" .*?)( ([0-9]+))*\\s*$"),u=r.split(`
`);let c=!1;for(let h=0;h<u.length;h++)if(u[h].startsWith("m="+t+" ")?c=!0:u[h].startsWith("m=")&&(c=!1),c){const v=u[h].match(s);v&&n.push(parseInt(v[1]));const f=u[h].match(a);f&&n.includes(parseInt(f[2]))&&n.push(parseInt(f[1]))}const l="a=(fmtp|rtcp-fb|rtpmap):([0-9]+)";let d="";c=!1;for(let h=0;h<u.length;h++)if(u[h].startsWith("m="+t+" ")?c=!0:u[h].startsWith("m=")&&(c=!1),c){const v=u[h].match(l);if(v&&!n.includes(parseInt(v[2])))continue;u[h].match(o)?d+=u[h].replace(o,"$1 "+n.join(" "))+`
`:d+=u[h]+`
`}else d+=u[h]+`
`;return d}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}oi.SERVICE_NAME="small-webrtc-transport";export{go as DailyMediaManager,oi as SmallWebRTCTransport};
